<script type="text/javascript">
    var conn = new WebSocket('ws://{{ wsUrl }}:{{ wsPort }}'),
            interval = {{ interval }},
            url = '{{ ajaxUrl }}',
            http,
            init = function(type, url, callback) {
                var http;
                if (window.XMLHttpRequest) {
                    http = new XMLHttpRequest();
                } else if (window.ActiveXObject) {
                    http = new ActiveXObject("Microsoft.XMLHTTP");
                } else {
                    return false;
                }

                http.open(type, url, true);
                http.onreadystatechange = callback;

                return http;
            },
            startRequest = function() {
                if (!!http) {
                    // if not: callback will be called multiple
                    http.onreadystatechange = null;
                }
                // init httpRequest object
                http = init('GET', url, handleResponse);
                if (!!http) {
                    // send request
                    http.send(null);
                } else {
                    throw 'browser not supported';
                }
            },
            handleResponse = function() {
                // if OK 200
                if (http.readyState == 4) {
                    var result = JSON.parse(http.responseText);

                    handleChanges(result);
                }

                // start next request in a interval
                setTimeout(startRequest, interval);
            },
            handleChanges = function(changes) {
                var content,
                        elements,
                        nodeArray,
                        i;

                // foreach property which was changed
                for (var propertyName in changes) {
                    if (changes.hasOwnProperty(propertyName)) {
                        content = changes[propertyName].content;

                        // find rdfa node
                        elements = document.querySelectorAll('*[property="' + propertyName + '"]');
                        i = 0;

                        // foreach node
                        nodeArray = [].slice.call(elements);
                        nodeArray.forEach(function(element) {
                            // set content and highlight class
                            element.innerHTML = content[i];
                            i++;
                        });
                    }
                }
            };

    conn.onopen = function(e) {
        console.log("Connection established!");

        var message = {
            command: 'start',
            content: '{{ contenUuid }}',
            type: 'preview',
            user: {{ userId }},
            params: {}
        };
        conn.send(JSON.stringify(message));
    };

    conn.onmessage = function(e) {
        var data = JSON.parse(e.data);
        console.log(data);
        if (data.command === 'changes') {
            handleChanges(data.params);
        }
    };

    conn.onclose = function(e) {
        window.close();
    };
    /*
     // start first request in a interval
     setTimeout(startRequest, interval);
     */
</script>
