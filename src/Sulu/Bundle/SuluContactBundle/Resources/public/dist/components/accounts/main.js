define(["sulucontact/model/account","app-config"],function(a,b){"use strict";var c={dialogEntityFoundTemplate:["<p><%= foundMessage %>:</p>",'<% if (typeof list !== "undefined") { %>',"<ul><%= list %></ul>","<% } %>",'<% if (typeof numChildren !== "undefined" && numChildren > 3 && typeof andMore !== "undefined") { %>',"<p><%= andMore %></p>","<% } %>","<p><%= description %></p>",'<% if (typeof checkboxText !== "undefined") { %>',"<p>",'   <label for="overlay-checkbox">','       <div class="custom-checkbox">','           <input type="checkbox" id="overlay-checkbox" class="form-element" />','           <span class="icon"></span>',"       </div>","       <%= checkboxText %>","</label>","</p>","<% } %>"].join("")};return{initialize:function(){if(this.bindCustomEvents(),this.account=null,this.accountType=null,"list"===this.options.display)this.renderList();else if("form"===this.options.display)this.renderForm().then(function(){this.prepareHeader()}.bind(this));else if("contacts"===this.options.display)this.renderContacts().then(function(){this.prepareHeader()}.bind(this));else{if("financials"!==this.options.display)throw"display type wrong";this.renderFinancials().then(function(){this.prepareHeader()}.bind(this))}},bindCustomEvents:function(){this.sandbox.on("sulu.contacts.account.delete",this.del.bind(this)),this.sandbox.on("sulu.contacts.accounts.save",this.save.bind(this)),this.sandbox.on("sulu.contacts.accounts.load",this.load.bind(this)),this.sandbox.on("sulu.contacts.contact.load",this.loadContact.bind(this)),this.sandbox.on("sulu.contacts.accounts.new",this.add.bind(this)),this.sandbox.on("sulu.contacts.accounts.delete",this.delAccounts.bind(this)),this.sandbox.on("sulu.contacts.accounts.financials.save",this.saveFinancials.bind(this)),this.sandbox.on("sulu.contacts.accounts.get-type",function(a,b){this.accountType||(this.accountType=this.getAccountType(a)),b(this.accountType)}.bind(this)),this.sandbox.on("sulu.contacts.accounts.list",function(a,b){var c="";a&&(c="/type:"+a),this.sandbox.emit("sulu.router.navigate","contacts/accounts"+c,b?!1:!0,!0)},this)},getAccountType:function(a){var c,d,e,f,g,h=0,i=b.getSection("sulu-contact");if(!i||i.length>0||!i.hasOwnProperty("accountTypes"))return!1;g=i.accountTypes,a.id?(c=a.type,d="id"):this.options.accountType?(c=this.options.accountType,d="name"):(c=0,d="id");for(e in g)if(f=g[e],f[d]===c){h=f;break}return h},enableTabsByType:function(a){var b;if(this.accountType=this.getAccountType(a),this.accountType||this.accountType.hasownProperty("tabs")){for(b in this.accountType.tabs)this.accountType.tabs[b]===!0&&this.sandbox.emit("husky.tabs.header.item.show",b);return this.accountType}},prepareHeader:function(){var a=this.account.toJSON(),b=this.enableTabsByType(a);this.setHeadlines(b,a)},setHeadlines:function(a,b){var c,d=[{title:"navigation.contacts"},{title:"contact.accounts.title",event:"sulu.contacts.accounts.list"}],e=this.sandbox.translate("contact.accounts.title");c=this.sandbox.translate(a?a.translation:"contact.account.type.basic"),this.options.id?(d.push({title:c+" #"+this.options.id}),e=b.name):d.push({title:c}),this.sandbox.emit("sulu.header.set-title",e),this.sandbox.emit("sulu.header.set-breadcrumb",d)},del:function(){this.confirmSingleDeleteDialog(this.options.id,function(a,b){a&&(this.sandbox.emit("sulu.header.toolbar.item.loading","options-button"),this.account.destroy({data:{removeContacts:!!b},processData:!0,success:function(){this.sandbox.emit("sulu.router.navigate","contacts/accounts")}.bind(this)}))}.bind(this))},save:function(a){this.sandbox.emit("sulu.header.toolbar.item.loading","save-button"),this.account.set(a),this.account.save(null,{success:function(b){var c=b.toJSON();a.id?this.sandbox.emit("sulu.contacts.accounts.saved",c):this.sandbox.emit("sulu.router.navigate","contacts/accounts/edit:"+c.id+"/details")}.bind(this),error:function(){this.sandbox.logger.log("error while saving profile")}.bind(this)})},saveFinancials:function(a){this.sandbox.emit("sulu.header.toolbar.item.loading","save-button"),this.account.set(a),this.account.save(null,{patch:!0,success:function(a){var b=a.toJSON();this.sandbox.emit("sulu.contacts.accounts.financials.saved",b)}.bind(this),error:function(){this.sandbox.logger.log("error while saving profile")}.bind(this)})},load:function(a){this.sandbox.emit("sulu.router.navigate","contacts/accounts/edit:"+a+"/details")},loadContact:function(a){this.sandbox.emit("sulu.router.navigate","contacts/contacts/edit:"+a+"/details")},add:function(a){this.sandbox.emit("sulu.router.navigate","contacts/accounts/add/type:"+a)},delAccounts:function(b){return b.length<1?void this.sandbox.emit("sulu.overlay.show-error","sulu.overlay.delete-no-items"):void this.showDeleteConfirmation(b,function(c,d){c&&b.forEach(function(b){var c=new a({id:b});c.destroy({data:{removeContacts:!!d},processData:!0,success:function(){this.sandbox.emit("husky.datagrid.record.remove",b)}.bind(this)})}.bind(this))}.bind(this))},renderList:function(){var a=this.sandbox.dom.createElement('<div id="accounts-list-container"/>');this.html(a),this.sandbox.start([{name:"accounts/components/list@sulucontact",options:{el:a,accountType:this.options.accountType?this.options.accountType:null}}])},renderFinancials:function(){var b=this.sandbox.dom.createElement('<div id="accounts-form-container"/>'),c=this.sandbox.data.deferred();return this.html(b),this.options.id&&(this.account=new a({id:this.options.id}),this.account.fetch({success:function(a){this.sandbox.start([{name:"accounts/components/financials@sulucontact",options:{el:b,data:a.toJSON()}}]),c.resolve()}.bind(this),error:function(){this.sandbox.logger.log("error while fetching contact"),c.reject()}.bind(this)})),c.promise()},renderForm:function(){this.account=new a;var b=this.sandbox.dom.createElement('<div id="accounts-form-container"/>'),c=this.sandbox.data.deferred();return this.html(b),this.options.id?(this.account=new a({id:this.options.id}),this.account.fetch({success:function(a){this.sandbox.start([{name:"accounts/components/form@sulucontact",options:{el:b,data:a.toJSON()}}]),c.resolve()}.bind(this),error:function(){this.sandbox.logger.log("error while fetching contact"),c.reject()}.bind(this)})):(this.accountType=this.getAccountType(this.options.accountType),this.account.set({type:this.accountType.id}),this.sandbox.start([{name:"accounts/components/form@sulucontact",options:{el:b,data:this.account.toJSON()}}]),c.resolve()),c.promise()},renderContacts:function(){var b=this.sandbox.dom.createElement('<div id="accounts-contacts-container"/>'),c=this.sandbox.data.deferred();return this.html(b),this.options.id&&(this.account=new a({id:this.options.id}),this.account.fetch({success:function(a){this.sandbox.start([{name:"accounts/components/contacts@sulucontact",options:{el:b,data:a.toJSON()}}]),c.resolve()}.bind(this),error:function(){this.sandbox.logger.log("error while fetching contact"),c.reject()}.bind(this)})),c.promise()},showDeleteConfirmation:function(a,b){0!==a.length&&(1===a.length?this.confirmSingleDeleteDialog(a[0],b):this.confirmMultipleDeleteDialog(a,b))},confirmSingleDeleteDialog:function(a,b){var c="/admin/api/accounts/"+a+"/deleteinfo";this.sandbox.util.ajax({headers:{"Content-Type":"application/json"},context:this,type:"GET",url:c,success:function(c){this.showConfirmSingleDeleteDialog(c,a,b)}.bind(this),error:function(a,b,c){this.sandbox.logger.error("error during get request: "+b,c)}.bind(this)})},showConfirmSingleDeleteDialog:function(a,b,d){if(d&&"function"!=typeof d)throw"callback is not a function";var e="contact.accounts.delete.desc",f="show-warning",g="sulu.overlay.be-careful",h=function(){var a=this.sandbox.dom.find("#overlay-checkbox").length&&this.sandbox.dom.prop("#overlay-checkbox","checked");d.call(this,!0,a)}.bind(this);parseInt(a.numChildren,10)>0?(f="show-error",g="sulu.overlay.error",h=void 0,e=this.sandbox.util.template(c.dialogEntityFoundTemplate,{foundMessage:this.sandbox.translate("contact.accounts.delete.sub-found"),list:this.template.dependencyListAccounts.call(this,a.children),numChildren:parseInt(a.numChildren,10),andMore:this.sandbox.util.template(this.sandbox.translate("public.and-number-more"),{number:"<strong><%= values.numChildren - values.children.length) %></strong>"}),description:this.sandbox.translate("contact.accounts.delete.sub-found-desc")})):parseInt(a.numContacts,10)>0&&(e=this.sandbox.util.template(c.dialogEntityFoundTemplate,{foundMessage:this.sandbox.translate("contact.accounts.delete.contacts-found"),list:this.template.dependencyListContacts.call(this,a.contacts),numChildren:parseInt(a.numContacts,10),andMore:this.sandbox.util.template(this.sandbox.translate("public.and-number-more"),{number:"<strong><%= values.numContacts - values.contacts.length) %></strong>"}),description:this.sandbox.translate("contact.accounts.delete.contacts-question"),checkboxText:this.sandbox.util.template(this.sandbox.translate("contact.accounts.delete.contacts-checkbox"),{number:parseInt(a.numContacts,10)})})),this.sandbox.emit("sulu.overlay."+f,g,e,d.bind(this,!1),h)},confirmMultipleDeleteDialog:function(a,b){var c="/admin/api/accounts/multipledeleteinfo";this.sandbox.util.ajax({headers:{"Content-Type":"application/json"},context:this,type:"GET",url:c,data:{ids:a},success:function(c){this.showConfirmMultipleDeleteDialog(c,a,b)}.bind(this),error:function(a,b,c){this.sandbox.logger.error("error during get request: "+b,c)}.bind(this)})},showConfirmMultipleDeleteDialog:function(a,b,d){if(d&&"function"!=typeof d)throw"callback is not a function";var e="contact.accounts.delete.desc",f="sulu.overlay.be-careful",g="show-warning",h=function(){var a=this.sandbox.dom.find("#delete-contacts").length&&this.sandbox.dom.prop("#delete-contacts","checked");d(!0,a)}.bind(this);parseInt(a.numChildren,10)>0?(g="show-error",f="sulu.overlay.error",h=void 0,e=this.sandbox.util.template(c.dialogEntityFoundTemplate,{foundMessage:this.sandbox.translate("contact.accounts.delete.sub-found"),description:this.sandbox.translate("contact.accounts.delete.sub-found-desc")})):parseInt(a.numContacts,10)>0&&(e=this.sandbox.util.template(c.dialogEntityFoundTemplate,{foundMessage:this.sandbox.translate("contact.accounts.delete.contacts-found"),numChildren:parseInt(a.numContacts,10),description:this.sandbox.translate("contact.accounts.delete.contacts-question"),checkboxText:this.sandbox.util.template(this.sandbox.translate("contact.accounts.delete.contacts-checkbox"),{number:parseInt(a.numContacts,10)})})),this.sandbox.emit("sulu.overlay."+g,f,e,d.bind(this,!1),h)},template:{dependencyListContacts:function(a){var b="<% _.each(contacts, function(contact) { %> <li><%= contact.firstName %> <%= contact.lastName %></li> <% }); %>";return this.sandbox.template.parse(b,{contacts:a})},dependencyListAccounts:function(a){var b="<% _.each(accounts, function(account) { %> <li><%= account.name %></li> <% }); %>";return this.sandbox.template.parse(b,{accounts:a})}}}});