define([],function(){"use strict";var a={fields:["address","email","fax","phone","url"],fieldTypes:[],trigger:".contact-options-toggle"},b={fieldId:"field-select",fieldTypeId:"field-type-select"},c={add:['<div class="grid-row">','   <div id="'+b.fieldId+'" class="grid-col-6"></div>','   <div id="'+b.fieldTypeId+'" class="grid-col-6"></div>',"</div>",'<div class="grid-row m-bottom-0"></div>'].join(""),editField:['<div class="grid-row divider">','<div class="grid-col-7 pull-left">','<div id="<%= dropdownId %>"></div>',"</div>",'<div class="grid-col-2 pull-right">','<div class="btn gray-dark fit only-icon pull-right">','<div class="icon-circle-minus"></div>',"</div>","</div>","</div>"].join("")},d=function(){this.sandbox.on("sulu.contact-form.add-collectionfilters",g.bind(this)),this.sandbox.on("sulu.contact-form.add-required",h.bind(this)),this.sandbox.on("sulu.contact-form.is.initialized",j.bind(this)),e.call(this)},e=function(){this.sandbox.on("husky.dependent-select.add-fields.all.items.selected",function(){this.sandbox.emit("husky.overlay.add-fields.okbutton.activate")}.bind(this)),this.sandbox.on("husky.dependent-select.add-fields.all.items.deselected",function(){this.sandbox.emit("husky.overlay.add-fields.okbutton.deactivate")}.bind(this))},f=function(){this.sandbox.form.removeCollectionFilter(this.form,"emails"),this.sandbox.form.removeCollectionFilter(this.form,"phones"),this.sandbox.form.removeCollectionFilter(this.form,"urls"),this.sandbox.form.removeCollectionFilter(this.form,"faxes"),this.sandbox.form.removeCollectionFilter(this.form,"notes")},g=function(a){this.form=a,this.sandbox.form.addCollectionFilter(this.form,"emails",function(a){return""===a.id&&delete a.id,""!==a.email}),this.sandbox.form.addCollectionFilter(this.form,"phones",function(a){return""===a.id&&delete a.id,""!==a.phone}),this.sandbox.form.addCollectionFilter(this.form,"urls",function(a){return""===a.id&&delete a.id,""!==a.url}),this.sandbox.form.addCollectionFilter(this.form,"faxes",function(a){return""===a.id&&delete a.id,""!==a.fax}),this.sandbox.form.addCollectionFilter(this.form,"notes",function(a){return""===a.id&&delete a.id,""!==a.value})},h=function(a){var b,c={email:"email-tpl"},d='#contact-fields *[data-mapper-property-tpl="<%= selector %>"]:first';-1!==a.indexOf("email")&&(b=this.sandbox.util.template(d,{selector:c.email}),this.sandbox.form.addConstraint(this.form,b+" input.email-value","required",{required:!0}),this.sandbox.dom.addClass(b+" label span:first","required"))},i=function(a,b){for(var c=-1,d=a.length;++c<d;)if(a[c].id===b)return a[c]},j=function(a){this.initialized?a.call(this):this.sandbox.on("sulu.contact-form.initialized",function(){a.call(this)}.bind(this))},k=function(){var a,c,d,e=this.sandbox.dom.children("#"+b.fieldId)[0],f=this.sandbox.dom.children("#"+b.fieldTypeId)[0],g=this.sandbox.dom.data(e,"selection"),h=this.sandbox.dom.data(f,"selection");a=this.dropdownDataArray[g],c=i(this.dropdownDataArray[g].items,h),d={},d[a.type]="",d[a.type+"Type"]={id:h,name:c.name},this.sandbox.form.addToCollection(this.form,a.collection,d),this.sandbox.emit("husky.overlay.add-fields.remove")},l=function(){this.sandbox.logger.log("fields-edit-ok clicked remove me later"),this.sandbox.stop(this.$editOverlayContent)},m=function(){var a,b,c,d=this.options.fieldTypes;for(c in d)for(a=-1,b=d[c].length;++a<b;)d[c][a].name=this.sandbox.translate(d[c][a].name);this.options.translatedFieldTypes=d},n=function(){this.editFieldsData=[],f.call(this);var a,b,d,e,h=this.sandbox.form.getData(this.form),i={},j=this.sandbox.dom.createElement('<div class="edit-fields"/>');g.call(this,this.form),i.address=h.addresses,i.email=h.emails,i.fax=h.faxes,i.phone=h.phones,i.url=h.urls;for(d in i)for(a=-1,b=i[d].length;++a<b;)e=this.sandbox.dom.createElement(_.template(c.editField)({dropdownId:"edit-dropdown-"+d+"-"+a})),this.editFieldsData.push({id:i[d][a].id,type:i[d][a][d+"Type"],name:this.sandbox.translate("public."+d),$element:e,dropdownId:"edit-dropdown-"+d+"-"+a,types:this.options.fieldTypes[d],dropdownData:null}),this.sandbox.dom.append(j,e);return j},o=function(){var a,b,c,d;for(a=-1,b=this.editFieldsData.length;++a<b;)for(this.editFieldsData[a].dropdownData=[],c=-1,d=this.editFieldsData[a].types.length;++c<d;)this.editFieldsData[a].dropdownData.push({id:this.editFieldsData[a].types[c].id,name:this.editFieldsData[a].name+" ("+this.editFieldsData[a].types[c].name+")"})},p=function(){o.call(this);for(var a=-1,b=this.editFieldsData.length;++a<b;)this.sandbox.start([{name:"select@husky",options:{el:this.sandbox.dom.find("#"+this.editFieldsData[a].dropdownId,this.editFieldsData[a].$element),instanceName:this.editFieldsData[a].dropdownId,data:this.editFieldsData[a].dropdownData,preSelectedElements:[this.editFieldsData[a].type.id]}}])},q=function(){this.$editOverlayContent=n.call(this),this.sandbox.start([{name:"overlay@husky",options:{title:this.sandbox.translate("public.edit-fields"),openOnStart:!0,instanceName:"edit-fields",data:this.$editOverlayContent,okCallback:l.bind(this)}}]),p.call(this)},r=function(){var a,d={};this.dropdownDataArray=[],this.$addOverlay=this.sandbox.dom.createElement(c.add),this.sandbox.util.foreach(this.options.fields,function(b,c){if(!this.options.fieldTypes||!this.options.fieldTypes[b])throw"contact-form@sulu: fieldTypes not defined for type "+b;a={id:c,name:this.sandbox.translate("public."+b),type:b,collection:b+"s",items:this.options.translatedFieldTypes[b]},d[b]=a}.bind(this)),d.address.disabled=!0,d.fax.collection="faxes",this.dropdownDataArray=Object.keys(d).map(function(a){return d[a]}),this.sandbox.start([{name:"overlay@husky",options:{title:this.sandbox.translate("public.add-fields"),openOnStart:!0,instanceName:"add-fields",okInactive:!0,data:this.$addOverlay,okCallback:k.bind(this)}},{name:"dependent-select@husky",options:{el:this.$addOverlay,singleSelect:!0,data:this.dropdownDataArray,instanceName:"add-fields",container:["#"+b.fieldId,"#"+b.fieldTypeId]}}])};return{initialize:function(){this.initialized=!1,this.$editOverlayContent=null,this.form=null,this.$addOverlay=null,this.dropdownDataArray=[],this.editFieldsData=[],this.options=this.sandbox.util.extend(!0,{},a,this.options),m.call(this),this.render(),d.call(this),this.sandbox.emit("sulu.contact-form.initialized"),this.initialized=!0},render:function(){var a=this.sandbox.dom.createElement('<div id="contact-form-options-container" />');this.sandbox.dom.append(this.$el,a),this.sandbox.start([{name:"dropdown@husky",options:{trigger:this.$el,triggerOutside:!0,el:a,alignment:"right",shadow:!0,toggleClassOn:this.$el,data:[{id:1,name:"public.edit-fields",callback:q.bind(this)},{id:2,name:"public.add-fields",callback:r.bind(this)}]}}])}}});