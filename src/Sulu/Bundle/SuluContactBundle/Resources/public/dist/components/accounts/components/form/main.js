define([],function(){"use strict";return function(){var a,b,c,d,e="#contact-form";return{view:!0,templates:["/admin/contact/template/account/form"],initialize:function(){this.saved=!0,d=1,this.formId="#contact-form",this.render(),this.setHeaderBar(!0),this.listenForChange()},render:function(){this.sandbox.once("sulu.contacts.set-defaults",this.setDefaults.bind(this)),this.html(this.renderTemplate("/admin/contact/template/account/form")),a=this.$find("#emails .emails-item:first"),b=this.$find("#phones .phones-item:first"),c=this.$find("#addresses .addresses-item:first"),this.sandbox.on("husky.dropdown.type.item.click",this.typeClick.bind(this));var d=this.initData(),e=[];this.options.data.id&&e.push({id:this.options.data.id}),this.companyInstanceName="companyAccount"+d.id,this.sandbox.start([{name:"auto-complete@husky",options:{el:"#company",remoteUrl:"/admin/api/accounts?searchFields=id,name&flat=true",getParameter:"search",value:d.parent?d.parent:null,instanceName:this.companyInstanceName,valueName:"name",noNewValues:!0,excludes:[{id:d.id,name:d.name}]}}]),this.createForm(d),this.bindDomEvents(),this.bindCustomEvents()},setDefaults:function(a){this.defaultTypes=a},createForm:function(a){var b=this.sandbox.form.create(e);b.initialized.then(function(){this.sandbox.form.setData(e,a).then(function(){a.urls[0]&&this.sandbox.dom.val("#url",a.urls[0].url),this.sandbox.start(e),this.sandbox.form.addConstraint(e,"#emails .emails-item:first input.email-value","required",{required:!0}),this.sandbox.dom.find("#emails .emails-item:first .remove-email").remove(),this.sandbox.dom.addClass("#emails .emails-item:first label span:first","required")}.bind(this))}.bind(this)),this.sandbox.form.addCollectionFilter(e,"emails",function(a){return""===a.id&&delete a.id,""!==a.email}),this.sandbox.form.addCollectionFilter(e,"phones",function(a){return""===a.id&&delete a.id,""!==a.phone}),this.sandbox.form.addCollectionFilter(e,"addresses",function(a){return""===a.id&&delete a.id,""!==a.street||""!==a.number||""!==a.zip||""!==a.city||""!==a.state})},bindDomEvents:function(){this.sandbox.dom.on("#addEmail","click",this.addEmail.bind(this)),this.sandbox.dom.on("#emails","click",this.removeEmail.bind(this),".remove-email"),this.sandbox.dom.on("#addPhone","click",this.addPhone.bind(this)),this.sandbox.dom.on("#phones","click",this.removePhone.bind(this),".remove-phone"),this.sandbox.dom.on("#addAddress","click",this.addAddress.bind(this)),this.sandbox.dom.on("#addresses","click",this.removeAddress.bind(this),".remove-address")},bindCustomEvents:function(){this.sandbox.on("sulu.edit-toolbar.delete",function(){this.sandbox.emit("sulu.contacts.account.delete",this.options.data.id)},this),this.sandbox.on("sulu.contacts.accounts.saved",function(a){this.options.data.id=a,this.setHeaderBar(!0)},this),this.sandbox.on("sulu.edit-toolbar.save",function(){this.submit()},this),this.sandbox.on("sulu.edit-toolbar.back",function(){this.sandbox.emit("sulu.contacts.accounts.list")},this)},initData:function(){var a=this.options.data;return this.fillFields(a.emails,2,{id:null,email:"",emailType:this.defaultTypes.emailType}),this.fillFields(a.phones,2,{id:null,phone:"",phoneType:this.defaultTypes.phoneType}),this.fillFields(a.addresses,1,{id:null,addressType:this.defaultTypes.addressType}),a},typeClick:function(a,b){this.sandbox.logger.log("email click",a),this.setHeaderBar(!1),b.find("*.type-value").data("element").setValue(a)},fillFields:function(a,b,c){for(;a.length<b;)a.push(c)},submit:function(){if(this.sandbox.logger.log("save Model"),this.sandbox.form.validate(e)){var a=this.sandbox.form.getData(e);a.urls=[{url:this.sandbox.dom.val("#url"),urlType:{id:this.defaultTypes.urlType.id}}],""===a.id&&delete a.id,a.parent={id:this.sandbox.dom.data("#"+this.companyInstanceName,"id")},this.sandbox.logger.log("data",a),this.sandbox.emit("sulu.contacts.accounts.save",a)}},checkRowMargin:function(a){var b=this.sandbox.dom.parent(a);this.sandbox.dom.children(b).length>2&&this.sandbox.dom.addClass(a,"m-top-20")},addEmail:function(){var b=a.clone();this.sandbox.dom.append("#emails",b),this.sandbox.form.addField(e,b.find(".id-value")),this.sandbox.form.addField(e,b.find(".type-value")),this.sandbox.form.addField(e,b.find(".email-value")),this.checkRowMargin(b),this.sandbox.start(b)},removeEmail:function(a){var b=$(a.target).parent().parent().parent();this.sandbox.form.removeField(e,b.find(".id-value")),this.sandbox.form.removeField(e,b.find(".type-value")),this.sandbox.form.removeField(e,b.find(".email-value")),b.remove()},addPhone:function(){var a=b.clone();this.sandbox.dom.append("#phones",a),this.sandbox.form.addField(e,a.find(".id-value")),this.sandbox.form.addField(e,a.find(".type-value")),this.sandbox.form.addField(e,a.find(".phone-value")),this.checkRowMargin(a),this.sandbox.start(a)},removePhone:function(a){var b=$(a.target).parent().parent().parent();this.sandbox.form.removeField(e,b.find(".id-value")),this.sandbox.form.removeField(e,b.find(".type-value")),this.sandbox.form.removeField(e,b.find(".phone-value")),b.remove()},addAddress:function(){var a=c.clone();a=this.setLabelsAndIdsForAddressItem(a),this.sandbox.dom.append("#addresses",a),$(window).scrollTop(a.offset().top),this.sandbox.form.addField(e,a.find(".id-value")),this.sandbox.form.addField(e,a.find(".type-value")),this.sandbox.form.addField(e,a.find(".street-value")),this.sandbox.form.addField(e,a.find(".number-value")),this.sandbox.form.addField(e,a.find(".addition-value")),this.sandbox.form.addField(e,a.find(".zip-value")),this.sandbox.form.addField(e,a.find(".city-value")),this.sandbox.form.addField(e,a.find(".state-value")),this.sandbox.form.addField(e,a.find(".country-value")),this.sandbox.start(a)},setLabelsAndIdsForAddressItem:function(a){var b=this.sandbox.dom.find("label[for]",a),c=this.sandbox.dom.find("input[type=text],select",a);return this.sandbox.dom.each(c,function(a,e){var f=this.sandbox.dom.data(e,"mapper-property");this.sandbox.logger.log(e,"value"),this.sandbox.dom.attr(b[a],{"for":f+d.toString()}),this.sandbox.dom.attr(c[a],{id:f+d.toString()})}.bind(this)),a},removeAddress:function(a){var b=$(a.target).parent().parent().parent();this.sandbox.form.removeField(e,b.find(".id-value")),this.sandbox.form.removeField(e,b.find(".type-value")),this.sandbox.form.removeField(e,b.find(".street-value")),this.sandbox.form.removeField(e,b.find(".number-value")),this.sandbox.form.removeField(e,b.find(".addition-value")),this.sandbox.form.removeField(e,b.find(".zip-value")),this.sandbox.form.removeField(e,b.find(".city-value")),this.sandbox.form.removeField(e,b.find(".state-value")),this.sandbox.form.removeField(e,b.find(".country-value")),b.remove()},setHeaderBar:function(a){if(a!==this.saved){var b=this.options.data&&this.options.data.id?"edit":"add";this.sandbox.emit("sulu.edit-toolbar.content.state.change",b,a)}this.saved=a},listenForChange:function(){this.sandbox.dom.on("#contact-form","change",function(){this.setHeaderBar(!1)}.bind(this),"select, input"),this.sandbox.dom.on("#contact-form","keyup",function(){this.setHeaderBar(!1)}.bind(this),"input")}}}()});