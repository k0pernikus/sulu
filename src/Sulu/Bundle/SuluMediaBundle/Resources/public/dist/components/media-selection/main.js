define(["sulumedia/collection/collections","sulumedia/model/collection"],function(a,b){"use strict";var c={visibleItems:6,instanceName:null,url:"",idsParameter:"ids",preselected:{ids:[],displayOption:"top",config:{}},idKey:"id",titleKey:"title",thumbnailKey:"thumbnails",thumbnailSize:"50x50",resultKey:"media",positionSelectedClass:"selected",hidePositionElement:!1,translations:{noMediaSelected:"media-selection.nomedia-selected",addImages:"media-selection.add-images",choose:"public.choose",collections:"media-selection.collections",visible:"public.visible",of:"public.of",upload:"media-selection.upload-new",collection:"media-selection.upload-to-collection",createNewCollection:"media-selection.create-new-collection",newCollection:"media-selection.new-collection",viewall:"public.view-all",viewless:"public.view-less"}},d={ids:[],displayOption:"top",config:{}},e={lastVisitedCollectionKey:"last-visited-collection"},f="sulu.media-selection.",g=function(){return k.call(this,"input-retrieved")},h=function(){return k.call(this,"data-changed")},i=function(){return k.call(this,"data-request")},j=function(){return k.call(this,"data-retrieved")},k=function(a){return f+(this.options.instanceName?this.options.instanceName+".":"")+a},l={skeleton:function(a,b){return['<div class="white-box form-element" id="',a.ids.container,'">','   <div class="header">','       <span class="fa-plus-circle icon left action" id="',a.ids.addButton,'"></span>','       <div class="position ',b,'">','<div class="husky-position" id="',a.ids.displayOption,'">','    <div class="top left" data-position="leftTop"></div>','    <div class="top middle" data-position="top"></div>','    <div class="top right" data-position="rightTop"></div>','    <div class="middle left" data-position="left"></div>','    <div class="middle middle inactive"></div>','    <div class="middle right" data-position="right"></div>','    <div class="bottom left" data-position="leftBottom"></div>','    <div class="bottom middle" data-position="bottom"></div>','    <div class="bottom right" data-position="rightBottom"></div>',"</div>","       </div>",'       <span class="fa-cog icon right border" id="',a.ids.configButton,'" style="display:none"></span>',"   </div>",'   <div class="content" id="',a.ids.content,'"></div>',"</div>"].join("")},noContent:function(a){return['<div class="no-content">','   <span class="fa-coffee icon"></span>','   <div class="text">',a,"</div>","</div>"].join("")},addTab:function(a,b){return['<div id="',a.ids.chooseTab,'">','   <div class="heading">',"       <h3>",b,"</h3>","   </div>",'   <div id="',a.ids.gridGroup,'"/>','   <div class="overlay-loader" id="',a.ids.loader,'"></div>',"</div>"].join("")},uploadTab:function(a,b){return['<div id="',a.ids.uploadTab,'">','   <div class="grid-row">',"       <label>",b,"</label>",'       <div id="',a.ids.collectionSelect,'"></div>',"   </div>",'   <div class="grid-row">','       <div id="',a.ids.dropzone,'"></div>',"   </div>","</div>"].join("")},contentItem:function(a,b,c,d){return['<li data-id="',a,'">','   <span class="num">',b,"</span>",'   <img src="',d,'"/>','   <span class="value">',c,"</span>",'   <span class="fa-times remove"></span>',"</li>"].join("")}},m=function(a){return"#"+this.options.ids[a]},n=function(){if(this.collections=new a,this.newCollection=new b,this.collectionArray=null,this.newCollectionId=null,this.gridGroupDeprecated=!1,this.viewAll=!1,this.options.ids={container:"media-selection-"+this.options.instanceName+"-container",addButton:"media-selection-"+this.options.instanceName+"-add",configButton:"media-selection-"+this.options.instanceName+"-config",displayOption:"media-selection-"+this.options.instanceName+"-display-option",content:"media-selection-"+this.options.instanceName+"-content",chooseTab:"media-selection-"+this.options.instanceName+"-choose-tab",uploadTab:"media-selection-"+this.options.instanceName+"-upload-tab",gridGroup:"media-selection-"+this.options.instanceName+"-grid-group",loader:"media-selection-"+this.options.instanceName+"-loader",collectionSelect:"media-selection-"+this.options.instanceName+"-collection-select",dropzone:"media-selection-"+this.options.instanceName+"-dropzone"},this.options.hidePositionElement?this.sandbox.dom.html(this.$el,l.skeleton(this.options,"hidden")):this.sandbox.dom.html(this.$el,l.skeleton(this.options,"")),this.$container=this.sandbox.dom.find(m.call(this,"container"),this.$el),this.$content=this.sandbox.dom.find(m.call(this,"content"),this.$el),this.$addButton=this.sandbox.dom.find(m.call(this,"addButton"),this.$el),this.$configButton=this.sandbox.dom.find(m.call(this,"configButton"),this.$el),this.sandbox.dom.data(this.$el,"media-selection")){var c=this.sandbox.util.extend(!0,{},d,this.sandbox.dom.data(this.$el,"media-selection"));K.call(this,c)}else K.call(this,this.options.preselected);o.call(this),r.call(this),this.itemsVisible=this.options.visibleItems,this.uploadCollection=null,this.URI={str:"",hasChanged:!1},L.call(this),N.call(this),F.call(this),J.call(this),A.call(this)},o=function(){var a=this.sandbox.translate(this.options.translations.noMediaSelected);this.sandbox.dom.html(this.$content,l.noContent(a))},p=function(){var a=this.$find(m.call(this,"loader"));a.length&&this.sandbox.start([{name:"loader@husky",options:{el:a,size:"100px",color:"#cccccc"}}])},q=function(){this.sandbox.stop(m.call(this,"loader"))},r=function(){this.sandbox.on("husky.tabs.overlaymedia-selection."+this.options.instanceName+".add.initialized",function(){p.call(this),this.collections.fetch({success:function(a){this.collectionArray=a.toJSON(),q.call(this),u.call(this),v.call(this),w.call(this)}.bind(this)})}.bind(this)),this.sandbox.on("husky.overlay.media-selection."+this.options.instanceName+".add.opened",function(){this.gridGroupDeprecated===!0&&(t.call(this),this.gridGroupDeprecated=!1)}.bind(this)),this.sandbox.on(g.call(this),function(){L.call(this),J.call(this)}.bind(this)),this.sandbox.on(j.call(this),function(){D.call(this)}.bind(this)),this.sandbox.on("sulu.grid-group."+this.options.instanceName+".height-changed",function(){this.sandbox.emit("husky.overlay.media-selection."+this.options.instanceName+".add.set-position")}.bind(this)),this.sandbox.on("sulu.grid-group."+this.options.instanceName+".initialized",function(){this.sandbox.emit("husky.overlay.media-selection."+this.options.instanceName+".add.set-position")}.bind(this)),this.sandbox.on("husky.select.media-selection-"+this.options.instanceName+".selected.item",s.bind(this)),this.sandbox.on("husky.dropzone.media-selection-"+this.options.instanceName+".files-added",z.bind(this))},s=function(a){this.uploadCollection=a,this.sandbox.emit("husky.dropzone.media-selection-"+this.options.instanceName+".change-url","/admin/api/media?collection%5Bid%5D="+a)},t=function(){this.sandbox.emit("sulu.grid-group."+this.options.instanceName+".reload",{data:this.collectionArray,preselected:this.data.ids})},u=function(){this.sandbox.start([{name:"grid-group@suluadmin",options:{data:this.collectionArray,el:this.sandbox.dom.find(m.call(this,"gridGroup")),instanceName:this.options.instanceName,gridUrl:"/admin/api/media?"+(""!=this.options.types?"types="+this.options.types+"&":"")+"collection=",preselected:this.data.ids,resultKey:this.options.resultKey,dataGridOptions:{view:"table",viewOptions:{table:{excludeFields:["id"],showHead:!1,cssClass:"minimal"}},pagination:!1,matchings:[{name:"id"},{name:"thumbnails",translation:"thumbnails",type:"thumbnails"},{name:"title",translation:"title"}]}}}])},v=function(){var a=this.sandbox.util.extend([],!0,this.collectionArray),b=this.sandbox.sulu.getUserSetting(e.lastVisitedCollectionKey)||"new";a.unshift({id:"new",title:this.sandbox.translate(this.options.translations.createNewCollection)}),s.call(this,b),this.sandbox.start([{name:"select@husky",options:{el:m.call(this,"collectionSelect"),instanceName:"media-selection-"+this.options.instanceName,valueName:"title",data:a,preSelectedElements:[b]}}])},w=function(){this.sandbox.start([{name:"dropzone@husky",options:{el:m.call(this,"dropzone"),url:"/admin/api/media?collection%5Bid%5D="+this.uploadCollection,method:"POST",paramName:"fileVersion",showOverlay:!1,instanceName:"media-selection-"+this.options.instanceName,afterDropCallback:x.bind(this),keepFilesAfterSuccess:!0}}])},x=function(){var a=this.sandbox.data.deferred();return"new"===this.uploadCollection?this.newCollectionId?(this.uploadCollection=this.newCollectionId,s.call(this,this.uploadCollection),a.resolve()):(this.newCollection.set({title:y.call(this)}),this.newCollection.save(null,{success:function(b){b=b.toJSON(),this.newCollectionId=b.id,s.call(this,b.id),this.collectionArray.push(b),a.resolve()}.bind(this),error:function(){this.sandbox.logger.log("Error while saving collection")}.bind(this)})):a.resolve(),a.promise()},y=function(){var a=this.sandbox.translate(this.options.translations.newCollection),b=0;return this.sandbox.util.foreach(this.collectionArray,function(c){-1!==c.title.indexOf(a)&&b++}.bind(this)),b>0&&(a=a+" ("+b+")"),a},z=function(a){a.length&&(this.sandbox.util.foreach(a,function(a){this.data.ids.push(a.id)}.bind(this)),this.sandbox.emit("sulu.labels.success.show","labels.success.media-upload-desc","labels.success"),t.call(this))},A=function(){this.sandbox.dom.on(m.call(this,"displayOption")+" > div","click",M.bind(this)),this.sandbox.dom.on(m.call(this,"content"),"click",B.bind(this),"li .remove"),this.sandbox.dom.on(this.$el,"click",function(){this.viewAll=!0,D.call(this)}.bind(this),".view-all"),this.sandbox.dom.on(this.$el,"click",function(){this.viewAll=!1,D.call(this)}.bind(this),".view-less")},B=function(a){var b=this.sandbox.dom.parents(a.currentTarget,"li"),c=this.sandbox.dom.data(b,"id");this.sandbox.dom.remove(b),C.call(this,c),this.data.ids.splice(this.data.ids.indexOf(c),1),this.itemsVisible--,I.call(this),0===this.items.length?o.call(this):E.call(this),this.gridGroupDeprecated=!0,this.sandbox.emit(h.call(this),this.data,this.$el)},C=function(a){for(var b=-1,c=this.items.length;++b<c;)if(this.items[b].id===a)return this.items.splice(b,1),!0;return!1},D=function(){if(this.itemsVisible=this.viewAll===!0?this.items.length:this.items.length<this.options.visibleItems?this.items.length:this.options.visibleItems,0!==this.items.length){for(var a,b=this.sandbox.dom.createElement('<ul class="items-list"/>'),c=-1,d=this.items.length;++c<d&&c<this.itemsVisible;)a=this.items[c][this.options.thumbnailKey][this.options.thumbnailSize],this.sandbox.dom.append(b,l.contentItem(this.items[c][this.options.idKey],c+1,this.items[c][this.options.titleKey],a));this.sandbox.dom.html(this.$content,b),E.call(this)}else o.call(this),I.call(this)},E=function(){(null===this.$footer||void 0===this.$footer)&&(this.$footer=this.sandbox.dom.createElement('<div class="footer"/>')),this.sandbox.dom.html(this.$footer,["<span>","<strong>"+this.itemsVisible+" </strong>",this.sandbox.translate(this.options.translations.of)," ","<strong>"+this.items.length+" </strong>",this.sandbox.translate(this.options.translations.visible),"</span>"].join("")),this.itemsVisible<this.items.length?this.sandbox.dom.append(this.sandbox.dom.find("span",this.$footer),'<strong class="view-all pointer"> ('+this.sandbox.translate(this.options.translations.viewall)+")</strong>"):this.itemsVisible>this.options.visibleItems&&this.sandbox.dom.append(this.sandbox.dom.find("span",this.$footer),'<strong class="view-less pointer"> ('+this.sandbox.translate(this.options.translations.viewless)+")</strong>"),this.sandbox.dom.append(this.$container,this.$footer)},F=function(){var a=l.addTab(this.options,this.sandbox.translate(this.options.translations.collections)),b=l.uploadTab(this.options,this.sandbox.translate(this.options.translations.collection)),c=this.sandbox.dom.createElement("<div/>");this.sandbox.dom.append(this.$el,c),this.sandbox.start([{name:"overlay@husky",options:{triggerEl:this.$addButton,cssClass:"media-selection-overlay",el:c,container:this.$el,draggable:!1,instanceName:"media-selection."+this.options.instanceName+".add",skin:"medium",slides:[{title:this.sandbox.translate(this.options.translations.addImages),okCallback:G.bind(this),cssClass:"media-selection-overlay-add",tabs:[{title:this.sandbox.translate(this.options.translations.choose),data:a},{title:this.sandbox.translate(this.options.translations.upload),data:b}]}]}}])},G=function(){var a=this.sandbox.data.deferred();this.sandbox.emit("sulu.grid-group."+this.options.instanceName+".get-selected-ids",function(b){K.call(this,{ids:b}),a.resolve()}.bind(this)),a.then(function(){this.sandbox.emit(g.call(this))}.bind(this))},H=function(){I.call(this);var a=this.sandbox.dom.createElement('<div class="loader"/>');this.sandbox.dom.html(this.$content,a),this.sandbox.start([{name:"loader@husky",options:{el:a,size:"100px",color:"#e4e4e4"}}])},I=function(){null!==this.$footer&&this.sandbox.dom.remove(this.$footer)},J=function(){this.URI.hasChanged===!0&&(this.sandbox.emit(i.call(this)),H.call(this),this.itemsVisible=this.options.visibleItems,this.sandbox.util.load(this.URI.str).then(function(a){this.items=a._embedded[this.options.resultKey],this.sandbox.emit(j.call(this))}.bind(this)).then(function(a){this.sandbox.logger.log(a)}.bind(this)))},K=function(a){for(var b in a)a.hasOwnProperty(b)&&(this.data[b]=a[b]);this.sandbox.dom.data(this.$el,"media-selection",this.data)},L=function(){var a=-1===this.options.url.indexOf("?")?"?":"&",b=[this.options.url,a,this.options.idsParameter,"=",(this.data.ids||[]).join(",")].join("");b!==this.URI.str?(""!==this.URI.str&&this.sandbox.emit(h.call(this),this.data,this.$el),this.URI.str=b,this.URI.hasChanged=!0):this.URI.hasChanged=!1},M=function(a){this.sandbox.dom.removeClass(this.sandbox.dom.find("."+this.options.positionSelectedClass,m.call(this,"displayOption")),this.options.positionSelectedClass),this.sandbox.dom.addClass(a.currentTarget,this.options.positionSelectedClass),K.call(this,{displayOption:this.sandbox.dom.data(a.currentTarget,"position")}),this.sandbox.emit(h.call(this),this.data,this.$el)},N=function(){var a=this.$find(m.call(this,"displayOption")),b=this.sandbox.dom.find('[data-position="'+this.data.displayOption+'"]',a);b.length&&this.sandbox.dom.addClass(b,this.options.positionSelectedClass)};return{historyClosed:!0,initialize:function(){this.options=this.sandbox.util.extend({},c,this.options),this.data={},n.call(this)}}});