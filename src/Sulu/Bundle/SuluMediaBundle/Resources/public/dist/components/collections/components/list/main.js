define(function(){"use strict";var a={data:{},slideDuration:250,instanceName:"collections",newCollectionColor:"#cccccc",newCollectionTitle:"sulu.media.new-collection"},b={openAllKey:"public.open-all",closeAllKey:"public.close-all",elementsKey:"public.elements",toggleAllClass:"toggle-all",slideDownIcon:"caret-right",slideUpIcon:"caret-down",collectionsClass:"collections",collectionClass:"collection",collectionSlideClass:"collection-slide",rightContentClass:"rightContent",titleClass:"collection-title",colorPointClass:"collection-color",newCollectionId:"new",newFormId:"collection-new",gridContainerClass:"thumbnail-grid"},c={toggleAll:['<span class="fa-<%= icon %> icon"></span>',"<span><%= text %></span>"].join(""),collection:['<div class="',b.collectionClass,'">','   <div class="head">','       <div class="',b.colorPointClass,'" style="background-color: <%= color %>"></div>','       <div class="fa-<%= icon %> icon"></div>','       <div class="',b.titleClass,'"><%= title %></div>','       <div class="',b.rightContentClass,'"></div>',"   </div>",'   <div class="',b.collectionSlideClass,'"></div>',"</div>"].join(""),totalElements:['<span class="total"><%= total %> <%= elements %></span>'].join("")};return{view:!0,fullSize:{width:!0,keepPaddings:!0},header:{title:"media.collections.title",noBack:!0,breadcrumb:[{title:"navigation.media"},{title:"media.collections.title"}]},templates:["/admin/media/template/media/collection-new"],initialize:function(){this.options=this.sandbox.util.extend(!0,{},a,this.options),this.sandbox.sulu.triggerDeleteSuccessLabel("labels.success.collection-deleted-desc"),this.toggleAll={$element:null,allOpen:!1},this.collections={},this.selectedMedias={},this.$overlayContent=null,this.lastClickedGrid=null,this.toolbarStarted=!1,this.bindCustomEvents(),this.render(),this.startListToolbar(),this.bindDomEvents()},bindCustomEvents:function(){this.sandbox.on("sulu.list-toolbar.add",this.openOverlay.bind(this)),this.sandbox.on("sulu.header.initialized",this.startListToolbar.bind(this)),this.sandbox.on("sulu.media.collections.collection-changed",this.updateCollection.bind(this)),this.sandbox.on("sulu.list-toolbar.delete",this.deleteMedia.bind(this)),this.sandbox.on("sulu.media.collections.media-saved",function(){this.sandbox.emit("husky.datagrid."+this.lastClickedGrid+".update")}.bind(this))},deleteMedia:function(){this.setSelectedMedias().then(function(){this.sandbox.sulu.showDeleteDialog(function(a){if(a===!0)for(var b in this.selectedMedias)this.sandbox.emit("sulu.media.collections.delete-media",this.selectedMedias[b],function(a,b){this.sandbox.emit("husky.datagrid."+this.collections[a].datagridName+".record.remove",b),this.collections[a].selectedElements=0,delete this.selectedMedias[a]}.bind(this,b),!0)}.bind(this))}.bind(this))},setSelectedMedias:function(){var a,b=0,c=Object.keys(this.collections).length,d=this.sandbox.data.deferred();for(var a in this.collections)this.collections[a].selectedElements>0?this.sandbox.emit("husky.datagrid."+this.collections[a].datagridName+".items.get-selected",function(e){this.selectedMedias[a]=e,b++,b===c&&d.resolve()}.bind(this)):(c--,b===c&&d.resolve());return d.promise()},addCollection:function(){if(!this.sandbox.form.validate("#"+b.newFormId))return!1;var a=this.sandbox.form.getData("#"+b.newFormId),c={mediaNumber:0,style:{color:a.color}};c=this.sandbox.util.extend(!0,{},c,a),this.renderCollection(this.sandbox.util.extend(!1,{},c),this.$find("."+b.collectionsClass),!0),this.sandbox.emit("sulu.media.collections.save-collection",c)},startListToolbar:function(){if(this.toolbarStarted===!1){this.toolbarStarted=!0;var a=this.sandbox.dom.createElement("</div>");this.sandbox.dom.append(this.$el,a),this.sandbox.start([{name:"list-toolbar@suluadmin",options:{el:a,instanceName:this.options.instanceName,template:"defaultNoSettings",inHeader:!0}}])}},render:function(){var a;this.toggleAll.$element=this.sandbox.dom.createElement('<div class="'+b.toggleAllClass+'"/>'),this.sandbox.dom.html(this.toggleAll.$element,this.sandbox.util.template(c.toggleAll)({icon:b.slideDownIcon,text:this.sandbox.translate(b.openAllKey)})),this.sandbox.dom.append(this.$el,this.toggleAll.$element),a=this.sandbox.dom.createElement('<div class="'+b.collectionsClass+'"/>'),this.sandbox.util.foreach(this.options.data,function(b){this.renderCollection(b,a,!1)}.bind(this)),this.initializeOverlay(),this.sandbox.dom.append(this.$el,a)},initializeOverlay:function(){var a=this.sandbox.dom.createElement('<div class="overlay-element"/>');this.sandbox.dom.append(this.$el,a),this.$overlayContent=this.renderTemplate("/admin/media/template/media/collection-new"),this.sandbox.once("husky.overlay.add-collection.opened",function(){this.sandbox.form.create("#"+b.newFormId),this.sandbox.form.setData("#"+b.newFormId,{title:this.sandbox.translate(this.options.newCollectionTitle),color:this.options.newCollectionColor})}.bind(this)),this.sandbox.start([{name:"overlay@husky",options:{el:a,title:this.sandbox.translate("sulu.media.add-collection"),instanceName:"add-collection",data:this.$overlayContent,okCallback:this.addCollection.bind(this)}}])},openOverlay:function(){this.sandbox.emit("husky.overlay.add-collection.open")},renderCollection:function(a,d,e){var f=this.sandbox.dom.createElement(this.sandbox.util.template(c.collection)({color:a.style.color,icon:b.slideDownIcon,title:a.title}));e===!0&&(a.id=b.newCollectionId),this.sandbox.dom.html(this.sandbox.dom.find("."+b.rightContentClass,f),this.sandbox.util.template(c.totalElements)({total:a.mediaNumber,elements:this.sandbox.translate(b.elementsKey)})),this.sandbox.dom.hide(this.sandbox.dom.find("."+b.collectionSlideClass,f)),this.sandbox.dom.append(d,f),this.collections[a.id]={id:a.id,$el:f,data:a,selectedElements:0,datagridName:null,datagridLoaded:!1},this.bindCollectionDomEvents(a.id)},updateCollection:function(a){if(this.collections[a.id])this.collections[a.id].data=a;else{if(!this.collections[b.newCollectionId])return this.sandbox.logger.log("Error. Undefined collection cannot be updated"),!1;this.collections[a.id]={id:a.id,$el:this.collections[b.newCollectionId].$el,data:a,selectedElements:0,datagridName:null,datagridLoaded:!1},this.sandbox.dom.off(this.collections[b.newCollectionId].$el),delete this.collections[b.newCollectionId],this.bindCollectionDomEvents(a.id)}this.sandbox.dom.html(this.sandbox.dom.find("."+b.titleClass,this.collections[a.id].$el),this.collections[a.id].data.title),this.sandbox.dom.css(this.sandbox.dom.find("."+b.colorPointClass,this.collections[a.id].$el),{"background-color":this.collections[a.id].data.style.color})},startCollectionDatagrid:function(a,c){this.sandbox.on("husky.datagrid."+this.options.instanceName+a+".number.selections",function(b){this.collections[a].selectedElements=b,this.refreshDeleteState()}.bind(this)),this.sandbox.on("husky.datagrid."+this.options.instanceName+a+".item.click",function(b){this.lastClickedGrid=this.collections[a].datagridName,this.sandbox.emit("sulu.media.collections.edit-media",b)}.bind(this)),this.collections[a].datagridName=this.options.instanceName+a,this.collections[a].datagridLoaded=!0;var d=this.sandbox.dom.createElement('<div class="'+b.gridContainerClass+'"/>');this.sandbox.dom.html(c,d),this.sandbox.sulu.initList.call(this,"mediaFields","/admin/api/media/fields",{el:d,url:"/admin/api/media?collection="+a,view:"thumbnail",pagination:"showall",instanceName:this.options.instanceName+a,searchInstanceName:this.options.instanceName,paginationOptions:{showall:{showAllHandler:this.showAllFiles.bind(this,a)}}})},refreshDeleteState:function(){for(var a in this.collections)if(this.collections[a].selectedElements>0)return this.sandbox.emit("sulu.list-toolbar."+this.options.instanceName+".delete.state-change",!0),!0;return this.sandbox.emit("sulu.list-toolbar."+this.options.instanceName+".delete.state-change",!1),!1},showAllFiles:function(a){this.sandbox.emit("sulu.media.collections.collection-edit",a)},bindDomEvents:function(){this.sandbox.dom.on(this.toggleAll.$element,"click",this.toggleAllCollections.bind(this))},bindCollectionDomEvents:function(a){a!==b.newCollectionId&&(this.sandbox.dom.on(this.collections[a].$el,"click",function(){this.toggleCollection(this.collections[a])}.bind(this),".head"),this.sandbox.dom.on(this.collections[a].$el,"click",function(b){this.sandbox.dom.stopPropagation(b),this.showAllFiles(a)}.bind(this),"."+b.titleClass))},toggleAllCollections:function(){var a,d;this.toggleAll.allOpen===!0?(a=this.slideUp.bind(this),this.toggleAll.allOpen=!1,this.sandbox.dom.html(this.toggleAll.$element,this.sandbox.util.template(c.toggleAll)({icon:b.slideDownIcon,text:this.sandbox.translate(b.openAllKey)}))):(a=this.slideDown.bind(this),this.toggleAll.allOpen=!0,this.sandbox.dom.html(this.toggleAll.$element,this.sandbox.util.template(c.toggleAll)({icon:b.slideUpIcon,text:this.sandbox.translate(b.closeAllKey)})));for(d in this.collections)a(this.collections[d])},toggleCollection:function(a){this.sandbox.dom.is(this.sandbox.dom.find("."+b.collectionSlideClass,a.$el),":visible")?this.slideUp(a):this.slideDown(a)},slideUp:function(a){this.sandbox.dom.slideUp(this.sandbox.dom.find("."+b.collectionSlideClass,a.$el),this.options.slideDuration),this.sandbox.dom.removeClass(this.sandbox.dom.find(".head .icon",a.$el),"fa-"+b.slideUpIcon),this.sandbox.dom.prependClass(this.sandbox.dom.find(".head .icon",a.$el),"fa-"+b.slideDownIcon)},slideDown:function(a){this.sandbox.dom.slideDown(this.sandbox.dom.find("."+b.collectionSlideClass,a.$el),this.options.slideDuration),this.sandbox.dom.removeClass(this.sandbox.dom.find(".head .icon",a.$el),"fa-"+b.slideDownIcon),this.sandbox.dom.prependClass(this.sandbox.dom.find(".head .icon",a.$el),"fa-"+b.slideUpIcon),a.datagridLoaded===!1&&this.startCollectionDatagrid(a.id,this.sandbox.dom.find("."+b.collectionSlideClass,a.$el))}}});