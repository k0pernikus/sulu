define(function(){"use strict";var a={data:{},slideDuration:250,instanceName:"collections",newCollectionColor:"#cccccc",newCollectionTitle:"sulu.media.new-collection"},b={openAllKey:"public.open-all",closeAllKey:"public.close-all",elementsKey:"public.elements",toggleAllClass:"toggle-all",slideDownIcon:"caret-right",slideUpIcon:"caret-down",collectionsClass:"collections",collectionClass:"collection",collectionSlideClass:"slide",rightContentClass:"rightContent",titleClass:"collection-title",titleChangerClass:"change-title",colorPointClass:"collection-color",newCollectionId:"new"},c="sulu.collection-list.",d={toggleAll:['<span class="fa-<%= icon %> icon"></span>',"<span><%= text %></span>"].join(""),collection:['<div class="',b.collectionClass,'">','   <div class="head">','       <div class="',b.colorPointClass,'" style="background-color: <%= color %>"></div>','       <div class="fa-<%= icon %> icon"></div>','       <div class="',b.titleClass,'"><%= title %></div>','       <input type="text" class="form-element '+b.titleChangerClass+'" value="<%= title %>"/>','       <div class="',b.rightContentClass,'"></div>',"   </div>",'   <div class="',b.collectionSlideClass,'"></div>',"</div>"].join(""),totalElements:['<span class="total"><%= total %> <%= elements %></span>'].join("")},e=function(){return g.call(this,"title-changed")},f=function(){return g.call(this,"collection-added")},g=function(a){return c+(this.options.instanceName?this.options.instanceName+".":"")+a};return{view:!0,header:{title:"media.collections.title",noBack:!0,breadcrumb:[{title:"navigation.media"},{title:"media.collections.title"}]},initialize:function(){this.options=this.sandbox.util.extend(!0,{},a,this.options),this.toggleAll={$element:null,allOpen:!1},this.collections={},this.selectedMedias={},this.bindCustomEvents(),this.render(),this.bindDomEvents()},bindCustomEvents:function(){this.sandbox.on("sulu.list-toolbar.add",this.addCollection.bind(this)),this.sandbox.on("sulu.header.initialized",this.startListToolbar.bind(this)),this.sandbox.on("sulu.media.collections.collection-changed",this.updateCollection.bind(this)),this.sandbox.on("sulu.list-toolbar.delete",this.deleteMedia.bind(this))},deleteMedia:function(){this.setSelectedMedias().then(function(){for(var a in this.selectedMedias)this.sandbox.emit("sulu.media.collections.delete-media",this.selectedMedias[a],function(a,b){this.sandbox.emit("husky.datagrid."+this.collections[a].datagridName+".record.remove",b),this.collections[a].selectedElements=0,delete this.selectedMedias[a]}.bind(this,a))}.bind(this))},setSelectedMedias:function(){var a,b=0,c=Object.keys(this.collections).length,d=this.sandbox.data.deferred();for(var a in this.collections)this.collections[a].selectedElements>0?this.sandbox.emit("husky.datagrid."+this.collections[a].datagridName+".items.get-selected",function(e){this.selectedMedias[a]=e,b++,b===c&&d.resolve()}.bind(this)):(c--,b===c&&d.resolve());return d.promise()},addCollection:function(){if(this.collections[b.newCollectionId])return this.showTitleInput(this.collections[b.newCollectionId]),!1;var a={id:b.newCollectionId,mediaNumber:0,title:this.sandbox.translate(this.options.newCollectionTitle),style:{color:this.options.newCollectionColor}};this.renderCollection(a,this.$find("."+b.collectionsClass)),this.showTitleInput(this.collections[b.newCollectionId])},startListToolbar:function(){var a=this.sandbox.dom.createElement("</div>");this.sandbox.dom.append(this.$el,a),this.sandbox.start([{name:"list-toolbar@suluadmin",options:{el:a,instanceName:this.options.instanceName,template:"defaultNoSettings",inHeader:!0}}])},render:function(){var a;this.toggleAll.$element=this.sandbox.dom.createElement('<div class="'+b.toggleAllClass+'"/>'),this.sandbox.dom.html(this.toggleAll.$element,this.sandbox.util.template(d.toggleAll)({icon:b.slideDownIcon,text:this.sandbox.translate(b.openAllKey)})),this.sandbox.dom.append(this.$el,this.toggleAll.$element),a=this.sandbox.dom.createElement('<div class="'+b.collectionsClass+'"/>'),this.sandbox.util.foreach(this.options.data._embedded,function(c){this.renderCollection(c,a),this.startCollectionDatagrid(c.id,this.sandbox.dom.find("."+b.collectionSlideClass,this.collections[c.id].$el))}.bind(this)),this.sandbox.dom.append(this.$el,a)},renderCollection:function(a,c){var e=this.sandbox.dom.createElement(this.sandbox.util.template(d.collection)({color:a.style.color,icon:b.slideDownIcon,title:a.title}));this.sandbox.dom.html(this.sandbox.dom.find("."+b.rightContentClass,e),this.sandbox.util.template(d.totalElements)({total:a.mediaNumber,elements:this.sandbox.translate(b.elementsKey)})),this.sandbox.dom.hide(this.sandbox.dom.find("."+b.collectionSlideClass,e)),this.sandbox.dom.append(c,e),this.collections[a.id]={$el:e,data:a,selectedElements:0,datagridName:null},this.bindCollectionDomEvents(a.id)},updateCollection:function(a){if(this.collections[a.id])this.collections[a.id].data=a;else{if(!this.collections[b.newCollectionId])return this.sandbox.logger.log("Error. Undefined collection cannot be updated"),!1;this.collections[a.id]={$el:this.collections[b.newCollectionId].$el,data:a},this.sandbox.dom.off(this.collections[a.id].$el),this.bindCollectionDomEvents(a.id),this.startCollectionDatagrid(a.id,this.sandbox.dom.find("."+b.collectionSlideClass,this.collections[a.id].$el)),delete this.collections[b.newCollectionId]}this.sandbox.dom.html(this.sandbox.dom.find("."+b.titleClass,this.collections[a.id].$el),this.collections[a.id].data.title),this.sandbox.dom.css(this.sandbox.dom.find("."+b.colorPointClass,this.collections[a.id].$el),{"background-color":this.collections[a.id].data.style.color})},startCollectionDatagrid:function(a,b){this.sandbox.on("husky.datagrid."+this.options.instanceName+a+".number.selections",function(b){this.collections[a].selectedElements=b,this.refreshDeleteState()}.bind(this)),this.collections[a].datagridName=this.options.instanceName+a,this.sandbox.sulu.initList.call(this,"mediaFields","/admin/api/media/fields",{el:b,url:"/admin/api/media?collection="+a,view:"thumbnail",pagination:"showall",instanceName:this.options.instanceName+a,searchInstanceName:this.options.instanceName,paginationOptions:{showall:{showAllHandler:this.showAllFiles.bind(this,a)}}})},refreshDeleteState:function(){for(var a in this.collections)if(this.collections[a].selectedElements>0)return this.sandbox.emit("sulu.list-toolbar."+this.options.instanceName+".delete.state-change",!0),!0;return this.sandbox.emit("sulu.list-toolbar."+this.options.instanceName+".delete.state-change",!1),!1},showAllFiles:function(a){this.sandbox.emit("sulu.media.collections.files",a)},bindDomEvents:function(){this.sandbox.dom.on(this.toggleAll.$element,"click",this.toggleAllCollections.bind(this))},bindCollectionDomEvents:function(a){a!==b.newCollectionId&&this.sandbox.dom.on(this.collections[a].$el,"click",function(){this.toggleCollection(this.collections[a])}.bind(this),".head"),this.sandbox.dom.on(this.collections[a].$el,"click",function(a){this.sandbox.dom.stopPropagation(a)}.bind(this),"."+b.titleChangerClass),this.sandbox.dom.on(this.collections[a].$el,"blur",function(){this.hideTitleInput(this.collections[a])}.bind(this),"."+b.titleChangerClass),this.sandbox.dom.on(this.collections[a].$el,"keyup",function(a){13===a.keyCode&&this.sandbox.dom.trigger(this.$find("."+b.titleChangerClass),"blur")}.bind(this),"."+b.titleChangerClass),this.sandbox.dom.on(this.collections[a].$el,"click",function(b){this.sandbox.dom.stopPropagation(b),this.showTitleInput(this.collections[a])}.bind(this),"."+b.titleClass)},showTitleInput:function(a){this.sandbox.dom.hide(this.sandbox.dom.find("."+b.titleClass,a.$el)),this.sandbox.dom.show(this.sandbox.dom.find("."+b.titleChangerClass,a.$el)),this.sandbox.dom.select(this.sandbox.dom.find("."+b.titleChangerClass,a.$el))},hideTitleInput:function(a){var c=this.sandbox.dom.val(this.sandbox.dom.find("."+b.titleChangerClass,a.$el));c!==a.data.title&&(this.sandbox.dom.html(this.sandbox.dom.find("."+b.titleClass,a.$el),c),a.data.id===b.newCollectionId?this.sandbox.emit(f.call(this),c):this.sandbox.emit(e.call(this),a.data.id,c)),this.sandbox.dom.hide(this.sandbox.dom.find("."+b.titleChangerClass,a.$el)),this.sandbox.dom.show(this.sandbox.dom.find("."+b.titleClass,a.$el))},toggleAllCollections:function(){var a,c;this.toggleAll.allOpen===!0?(a=this.slideUp.bind(this),this.toggleAll.allOpen=!1,this.sandbox.dom.html(this.toggleAll.$element,this.sandbox.util.template(d.toggleAll)({icon:b.slideDownIcon,text:this.sandbox.translate(b.openAllKey)}))):(a=this.slideDown.bind(this),this.toggleAll.allOpen=!0,this.sandbox.dom.html(this.toggleAll.$element,this.sandbox.util.template(d.toggleAll)({icon:b.slideUpIcon,text:this.sandbox.translate(b.closeAllKey)})));for(c in this.collections)a(this.collections[c])},toggleCollection:function(a){this.sandbox.dom.is(this.sandbox.dom.find("."+b.collectionSlideClass,a.$el),":visible")?this.slideUp(a):this.slideDown(a)},slideUp:function(a){this.sandbox.dom.slideUp(this.sandbox.dom.find("."+b.collectionSlideClass,a.$el),this.options.slideDuration),this.sandbox.dom.removeClass(this.sandbox.dom.find(".head .icon",a.$el),"fa-"+b.slideUpIcon),this.sandbox.dom.prependClass(this.sandbox.dom.find(".head .icon",a.$el),"fa-"+b.slideDownIcon)},slideDown:function(a){this.sandbox.dom.slideDown(this.sandbox.dom.find("."+b.collectionSlideClass,a.$el),this.options.slideDuration),this.sandbox.dom.removeClass(this.sandbox.dom.find(".head .icon",a.$el),"fa-"+b.slideDownIcon),this.sandbox.dom.prependClass(this.sandbox.dom.find(".head .icon",a.$el),"fa-"+b.slideUpIcon)}}});